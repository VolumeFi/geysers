#!/usr/bin/python3

import pytest
import time

def test_main(StakeRewardsFactoryContract, UniswapV2Router02, UniswapExchangeAdd, USDC, WETH, DAI_WETH, accounts, Contract):
    UniswapExchangeAdd.investTokenForUniPair("0x0000000000000000000000000000000000000000",DAI_WETH, 2 * 10 ** 18, 1, {"from": accounts[0], "value": 2 * 10 ** 18 + 5 * 10 ** 15})
    UniswapV2Router02.swapETHForExactTokens(4000 * 10 ** 6, [WETH, USDC], accounts[0], 2 ** 256 - 1, {"from":accounts[0], "value": 2 * 10 ** 18})
    bal = USDC.balanceOf(accounts[0])
    USDC.approve(StakeRewardsFactoryContract, bal, {"from": accounts[0]})
    tx1 = StakeRewardsFactoryContract.createNewContract(USDC, DAI_WETH, 4000 * 10 ** 6, 30, {"from": accounts[0]})
    # print("started")
    # print(tx1.info())
    # print(tx1.events['PoolCreated']['poolAddress'])
    NewStakeRewardsContract = Contract.from_abi("StakeRewardsContract", tx1.events['PoolCreated']['poolAddress'], [{"anonymous":False,"inputs":[{"indexed":True,"name":"user","type":"address"},{"indexed":False,"name":"amount","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"name":"user","type":"address"},{"indexed":False,"name":"amount","type":"uint256"}],"name":"Withdrawn","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"name":"user","type":"address"},{"indexed":False,"name":"reward","type":"uint256"}],"name":"RewardPaid","type":"event"},{"anonymous":False,"inputs":[{"indexed":False,"name":"reward","type":"uint256"}],"name":"RewardAdded","type":"event"},{"anonymous":False,"inputs":[{"indexed":False,"name":"token","type":"address"},{"indexed":False,"name":"amount","type":"uint256"}],"name":"Recovered","type":"event"},{"anonymous":False,"inputs":[{"indexed":False,"name":"newDuration","type":"uint256"}],"name":"RewardsDurationUpdated","type":"event"},{"gas":282687,"inputs":[{"name":"_owner","type":"address"},{"name":"_rewardsDistribution","type":"address"},{"name":"_rewardsToken","type":"address"},{"name":"_stakingToken","type":"address"},{"name":"_rewardsDuration","type":"uint256"},{"name":"_uniswapRemove","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_owner","type":"address"},{"name":"_rewardsDistribution","type":"address"},{"name":"_rewardsToken","type":"address"},{"name":"_stakingToken","type":"address"},{"name":"_rewardsDuration","type":"uint256"},{"name":"_uniswapRemove","type":"address"}],"outputs":[],"stateMutability":"nonpayable","type":"constructor"},{"gas":1561,"inputs":[],"name":"lastTimeRewardApplicable","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":9988,"inputs":[],"name":"rewardPerToken","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":22029,"inputs":[{"name":"account","type":"address"}],"name":"earned","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":3895,"inputs":[],"name":"getRewardForDuration","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":335534,"inputs":[{"name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":1014899,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":490966,"inputs":[],"name":"getReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":1450468,"inputs":[],"name":"exit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":641914,"inputs":[{"name":"amount","type":"uint256"},{"name":"token","type":"address"},{"name":"minTokenAmount","type":"uint256"}],"name":"withdrawToToken","outputs":[],"stateMutability":"payable","type":"function"},{"gas":1077552,"inputs":[{"name":"token","type":"address"},{"name":"minTokenAmount","type":"uint256"}],"name":"exitToToken","outputs":[],"stateMutability":"payable","type":"function"},{"gas":315985,"inputs":[{"name":"reward","type":"uint256"}],"name":"notifyRewardAmount","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":36766,"inputs":[{"name":"newRewardsDistribution","type":"address"}],"name":"updateRewardsDistribution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":236202,"inputs":[{"name":"_timestamp","type":"uint256"}],"name":"updatePeriodFinish","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":9323,"inputs":[{"name":"token","type":"address"},{"name":"amount","type":"uint256"}],"name":"recoverERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":38878,"inputs":[{"name":"_rewardsDuration","type":"uint256"}],"name":"setRewardsDuration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"gas":1568,"inputs":[],"name":"rewardsToken","outputs":[{"name":"","type":"address"}],"stateMutability":"view","type":"function"},{"gas":1598,"inputs":[],"name":"stakingToken","outputs":[{"name":"","type":"address"}],"stateMutability":"view","type":"function"},{"gas":1628,"inputs":[],"name":"periodFinish","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":1658,"inputs":[],"name":"rewardRate","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":1688,"inputs":[],"name":"rewardsDuration","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":1718,"inputs":[],"name":"lastUpdateTime","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":1748,"inputs":[],"name":"rewardPerTokenStored","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":1778,"inputs":[],"name":"rewardsDistribution","outputs":[{"name":"","type":"address"}],"stateMutability":"view","type":"function"},{"gas":1808,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"stateMutability":"view","type":"function"},{"gas":1838,"inputs":[],"name":"uniswapRemove","outputs":[{"name":"","type":"address"}],"stateMutability":"view","type":"function"},{"gas":2083,"inputs":[{"name":"arg0","type":"address"}],"name":"userRewardPerTokenPaid","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":2113,"inputs":[{"name":"arg0","type":"address"}],"name":"rewards","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":1928,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"gas":2173,"inputs":[{"name":"arg0","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"}])
    bal2 = DAI_WETH.balanceOf(accounts[0])
    DAI_WETH.approve(NewStakeRewardsContract, bal2, {"from": accounts[0]})
    NewStakeRewardsContract.stake(bal2, {"from": accounts[0]})
    # print("staked")
    # accounts[1].transfer(accounts[2], "1 ether")
    # print(USDC.balanceOf(NewStakeRewardsContract))
    # print(DAI_WETH.balanceOf(NewStakeRewardsContract))
    # print("sleep")
    time.sleep(30)
    # print("wake up")
    # print("rewardrate")
    # print(NewStakeRewardsContract.rewardRate())
    # print("RewardPerToken")
    # print(NewStakeRewardsContract.rewardPerToken())
    # print("LastTimeRewardApplicable")
    # print(NewStakeRewardsContract.lastTimeRewardApplicable())
    # print("Earned")
    # print(NewStakeRewardsContract.earned(accounts[0]))
    NewStakeRewardsContract.exitToToken("0x0000000000000000000000000000000000000000", 0, {"from": accounts[0], "value": 5 * 10 ** 15})
    # bal3 = accounts[0].balance()
    # print(USDC.balanceOf(NewStakeRewardsContract))
    # print(DAI_WETH.balanceOf(NewStakeRewardsContract))
    # print(accounts[0].balance() - bal3)